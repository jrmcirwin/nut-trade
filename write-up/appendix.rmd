Lead-lag
```{r lead result,results = "asis",messages = FALSE}
load("~/Research/Anemia/Anemia/data/lead_regression_table.Rdata")
x

```

Quantile regressions

abstract: "I explore the effect of the 2008 world food price crisis on fetal nutrition in Senegal using data on infant and child hemoglobin from 2010-2012.  While previous work has explored the effect of the 2008 crisis on child health, mine is the first to use a fetal origins approach, which allows data collected several years after the crisis to be used in analysis. With this broader variation, I am able to test simultaneously test two hypotheses about the distribution of effect: (1) that urban dwellers were more affected than rural-dwellers, and (2) that the effect of the crisis diminished with distance to Dakar, the port and economic hub of Senegal. I find consistent evidence in support of the urban hypothesis, and weak evidence for the distance-to-Dakar hypothesis. The strongest effect was experienced by the urban-poor of Dakar. In accordance with the biological mechanism, there is significant attenuation of effect from 2010 to 2012, indicating that in-utero shocks to iron-stores may be hard to detect later in life."


Selection


# Heat Maps
```{r heat maps}
library("ggvoronoi")
load("~/Research/Anemia/Anemia/data/heatmap.Rdata")
x <- map_data("world2","senegal")
x$long <- x$long - 360
ggplot(data=filter(env,YEAR==2010|YEAR==2012), aes(x=LONGNUM, y=LATNUM)) +geom_voronoi(outline=x)+ geom_point(aes(color=URBAN))
  geom_voronoi(outline=x)

ggplot(data=filter(env,YEAR!=2005&YEAR!=2014), aes(x=LONGNUM, y=LATNUM)) + 
  geom_voronoi(aes(fill=food), outline=x)+scale_fill_viridis_c(option="magma", direction=1) 
ggplot(data=filter(env,YEAR!=2005&YEAR!=2014), aes(x=LONGNUM, y=LATNUM)) + 
  geom_voronoi(aes(fill=export), outline=x)+scale_fill_viridis_c(option="magma", direction=1) 

ggplot(data=env, aes(x=LONGNUM, y=LATNUM)) + 
  geom_voronoi(aes(fill=wealth), outline=x)+scale_fill_viridis_c(option="magma", direction=1) 
ggplot(data=filter(env,YEAR!=2005&YEAR!=2014), aes(x=LONGNUM, y=LATNUM)) + 
  geom_voronoi(aes(fill=land), outline=x)+scale_fill_viridis_c(option="magma", direction=1) 
```


ggplot(data=filter(cluster, urban==1), aes(x=LONGNUM, y=LATNUM)) + ggvoronoi::geom_voronoi(outline = x)+
  geom_point(aes(color=effect))+scale_color_viridis_c(option="magma", direction=-1) +
  labs(title = "Model-Predicted effect of Exposure by DHS Cluster: Urban Clusters", x= "Longitude",y = "Latitude", fill = "Effect")

ggplot(data=filter(cluster, urban==0), aes(x=LONGNUM, y=LATNUM)) + ggvoronoi::geom_voronoi(outline = x)+
  geom_point(aes(color=effect))+scale_color_viridis_c(option="magma", direction=-1) +
  labs(title = "Model-Predicted effect of Exposure by DHS Cluster: Rural Clusters", x= "Longitude",y = "Latitude", fill = "Effect")


 1: A note on Methodology

One potential route would be to regress child hemoglobin on world prices during gestation. This approach is complicated by the fact that prices during gestation are a distribution, not a value. The relationship between monthly price and hemoglobin will likely be non-linear, as households are able to smooth small price changes, but not large increases. We could capture this non-linear relationship using a "bin" approach. First we would discretize the problem, breaking up price into $n$ bins. Then we would count the number of months each child spent in each price-bin over the course of gestation. 

However, this approach assumes that the timing of price is irrelevant. Given that different stages of pregnancy have very different iron requirements, the timing of price, not only the level each month, is important. Second, because of credit-constraints, a month of high prices will be harder on a household if it falls after another month of high prices than after a month of low prices. Third, because prices affect iron intake, a flow, but hemoglobin is determined by iron stocks, we would expect persistent effects over time.

Because of this complexity, and the fact that the 2008 crisis dominates variation over the period of study, I will instead concentrate on a single period of unusually high prices. I will construct the proper control group based on knowledge about the biological process of hemoglobin formation. Doing this will also allow me to speak directly to a substantial literature which is interested in effects of the 2008 crisis.



With regards to the 2008 food price crisis, I hope to speak to the following questions:

1. Was there a detectable effect of the crisis in Senegal?
2. How did this effect depend on household wealth and connectivity to the world market?
3. Did the crisis have a different effect for urban and rural households?

There has been much research on the 2008 crisis (I review it later). However, reserachers have largely been unable to test these simple hypotheses because of the lack of suitable data. Previous approaches have used child health contemporaneous to the crisis. Due to the biological mechanisms of iron accumulation, hemoglobin levels should be more sensitive to nutritional insults in-utero than post-birth, facilitating a fetal-origins approach which allows data collected 2-4 years later to be used in analysis.

The goal of this paper is two use two issues in contemporary food-policy and nutrition in order to shed light on one another. They are anemia and food prices.

Anemia affect over 1 billion people around the world, and is responsible for more than a million deaths a year. Anemia has many causes, but the most common is micro-nutrient deficiency. Anemia depends on the quality and quantity of food that a person has access to. The consequences of anemia are numerous and serious. In adults, anemia causes fatigue and blindness. Anemia in adults is estimated to result in lost GDP of over 4% a year in south Asian and SSA. [@hortonEconomicsIronDeficiency2003].

In infants, iron-deficiency impairs motor and cognitive development. This is a critical period, and the damage caused by iron-deficiency in infancy cannot be undone. Anemia is particularly a problem for women, because of menstration. Even more so, it is a problem for pregnant women, who require a great deal of iron to build the fetus and placenta, and lose a great deal of blood during childbirth. Anemia is a problem of female empowerment and discrimination against women.

Moreover, the discrimination against women contributes negatively to the health of everyone in society. Anemia is an excellent example of what Amartya Sen called "The Hidden Costs of Gender Inequality" [@osmaniHiddenPenaltiesGender2003c]. The malnutrition of women leads to anemia. This anemia prevents them from passing on the infants the required iron (more on this later). Thus, an anemic woman begets an anemic child who becomes an anemic woman. The intergenerational aspect of anemia is well-recognized, and it is a major concern at the nexus of gender inequality and development.

The second issue is food prices. High food prices mean less food for purchasers around the world, but they also mean higher incomes for those who sell food. The effect of increased food prices on the well-being of poor people is thus debated, and depends on the context. How food prices relate to nutrition is also unclear.

The two issues will shed light on eachother. Looking at anemia data will give us a response variable on which we can test the effect of food prices on nutrition in developing countries. Using food prices will allow me to characterize the intergenerational importance of iron-consumption on a broad scale. It will allow us to start understanding the magnitude of importance of the fetal period on hemoglobin in the real world.

More specifically, I will look at the effect of a specific period of high prices, and how this affected fetal nutri


## Quantile Regression
All of the regression reported in the main paper are median regressions. The reader might also be interested in other quantiles of the hemoglobin distribution. Here I report the combined specification from the results section, with quintiles. The noisiness of the data does not allow for any clear interpretation.

```{r quantiles}
load("~/Research/Anemia/Anemia/data/hemforage.Rdata")
dhs <- dhs %>% filter(survey==2010|survey==2012)
dhs <- droplevels(dhs)

comb10<- quantreg::rq(hemfa~exposure*dist_dakar+poly(Time,2)+exposure*urban+exposure*wealth,tau = c(1:4)/5,data=filter(dhs,survey==2010))
comb12<- quantreg::rq(hemfa~exposure*dist_dakar+poly(Time,2)+exposure*urban+exposure*wealth,tau = c(1:4)/5,data=filter(dhs,survey==2012))

plot(summary(comb10),parm = c(2,6,7,9))
plot(summary(comb12),parm = c(2,6,7,9))

```


# Appendix 3: More information on the spatial distribution of variables in Senegal

In case the reader is interested in the distribution of agriculture and wealth across Senegal (as I was), I have included some heat-maps which depict variables at the cluster level. Below I report food production, as well as commercial agriculture (sugarcane, palm nuts and cotton).


```{r heat maps}
library("ggvoronoi")
load("~/Research/Anemia/Anemia/data/heatmap.Rdata")
x <- map_data("world2","senegal")
x$long <- x$long - 360
ggplot(data=filter(env,YEAR!=2005&YEAR!=2014), aes(x=LONGNUM, y=LATNUM)) + 
  geom_voronoi(aes(fill=food), outline=x)+scale_fill_viridis_c(option="magma", direction=1) +
  labs(title = "Food Production across Senegal", x = "",y="")
ggplot(data=filter(env,YEAR!=2005&YEAR!=2014), aes(x=LONGNUM, y=LATNUM)) + 
  geom_voronoi(aes(fill=export), outline=x)+scale_fill_viridis_c(option="magma", direction=1) +
  labs(title = "Commercial Agriculture across Senegal", x = "",y="")

ggplot(data=env, aes(x=LONGNUM, y=LATNUM)) + 
  geom_voronoi(aes(fill=wealth/10), outline=x)+scale_fill_viridis_c(option="magma", direction=1) +
  labs(title = "Wealth across Senegal", x = "",y="")
ggplot(data=filter(env,YEAR!=2005&YEAR!=2014), aes(x=LONGNUM, y=LATNUM)) + 
  geom_voronoi(aes(fill=land), outline=x)+scale_fill_viridis_c(option="magma", direction=-1) +
  labs(title = "Land Ownership across Senegal", x = "",y="")
```



```{r urb-rur birth, fig.align = "center",fig.cap = "Hemoglobin-for-age by Birth Quarter"}
load("~/Research/Anemia/Anemia/data/urban_birthq_graph.Rdata")
ggplot(filter(all_sen, is.na(urban)))+ geom_point(aes(x = birth_q, y=all_sen), size = 3)+
  geom_vline(xintercept = 8)+  labs(title = "Median hemoglobin by Birth Quarter: All of Senegal",x = "Birth Quarter: 0 = 2006", y= "Median Hemoglobin") 
ggplot(filter(all_sen,urban==1))+ geom_point(aes(x = birth_q, y=all_sen), size = 3)+
  geom_vline(xintercept = 8)+  labs(title = "Median hemoglobin by Birth Quarter: Urban 2010",x = "Birth Quarter: 0 = 2006", y= "Median Hemoglobin")
ggplot(filter(all_sen,urban==0))+ geom_point(aes(x = birth_q, y=all_sen), size = 3)+
  geom_vline(xintercept = 8)+  labs(title = "Median hemoglobin by Birth Quarter: Rural 2010",x = "Birth Quarter: 0 = 2006", y= "Median Hemoglobin")

```

 As illustration, below I provide a the distribution of hemoglobin for children of age 36 months:

```{r hemo dist,fig.height = 6, fig.width = 10, fig.align = "center", fig.cap = "Example of Hemoglobin distribution for specific age"}
#load("~/Research/Anemia/Anemia/data/cohort.Rdata")
ggplot(filter(dhs,age==36)) + geom_density(aes(x=hemoglobin))+ geom_vline(aes(xintercept = 105))+
labs(title = "PDF of Hemoglobin: Age 36 months", x = "Hemoglobin: g/L", y ="Density")

```

```{r dist_wealth,message=FALSE, fig.height=6, fig.width=10, fig.align = "center", fig.cap = "Relationship of household wealth and distance-to-Dakar"}
## Interpreation of results: combining the regressions with distribution across senegal. calculate effect by cluster
load("~/Research/Anemia/Anemia/data/hemforage.Rdata")
dhs <- dhs %>% filter(survey==2010|survey==2012)
dhs <- droplevels(dhs)
dhs <- dhs %>% filter(!is.na(dist_dakar))

ggplot(dhs)+geom_smooth(aes(x=dist_dakar,y=wealth,color = urban))+labs(title= "Wealth Distribution by Distance to Dakar", x= "Distance-to-Dakar", y = "Conditional Mean of Wealth")+scale_fill_discrete(labels = c("Rural","Urban"))
```




Here I plot the median hemoglobin by birth-quarter. I highlight the two quarters which are exposed to the 2008 crisis *in-utero*. First, I present the data for all of Senegal. If one squints, one may discern a dip. Second, I plot the data for Dakar. According to my predictions, Dakar should show the strongest effect of the 2008 crisis. While certainly not obvious, there is a more apparent dip than for all of Senegal. Third, I present the data for Kolda, a region to the southeast of Dakar, relatively isolated and with significant food production. I would not expect to see much of a dip here, and no dip is evident.


This evidence is unclear. The effect of the 2008 crisis could not have been not uniformly large across the country, or else it would be apparent.

Next I turn to regression, in order to test the hypotheses stated above. I use quantile regression evaluated at the median, bootstrapped standard errors, and all regressions include a quadratic time trend.





These figures were created after seeing the regression results above. Therefore, they should not be interpreted as *separate* evidence from the regression results above. Rather, it is an illustration of those results using the raw data. 

```{r wealth,fig.height=6, fig.width=10, fig.align = "center", fig.cap = "DHS Wealth Index across Surveys"}
## Interpreation of results: combining the regressions with distribution across senegal. calculate effect by cluster
load("~/Research/Anemia/Anemia/data/hemforage.Rdata")
dhs <- dhs %>% filter(survey==2010|survey==2012)
dhs <- droplevels(dhs)
dhs <- dhs %>% filter(!is.na(dist_dakar))

ggplot(dhs)+geom_density(aes(x=wealth,color = urban:survey))+ labs(title= "Wealth Distribution across Surveys", x= "Wealth", y="Density")+
scale_color_brewer(palette="Set1",labels = c("2010 Rural","2012 Rural","2010 Urban","2012 Urban"))
```

As emphasized by Sen (1980), food security depends on the combination of level and volatility of food entitlements. From the simplest model of comparative advantage, we know that opening to trade induces specialization. This specialization will increase average incomes, but the effect of specialization and trade on volatility is unresolved [@giovanniTradeOpennessVolatility2009; @burgessCanOpennessMitigate2010]. The 2008 crisis can be thought of as an extreme case of market volatility. My project then quantifies the effect of this unforeseen shock on maternal health in Senegal.




ying the effect of the crisis is difficult because it affects everyone in the world at a given time. If we are to use the standard measures of nutrition, like weight-for-height, then the data-collection must have been contemporaneous with the crisis. To observe the effect of the crisis, we must compare the same children before and after the crisis occurs. If we observe these children several years after the crisis, there is no control group or exposed group. Everyone was exposed to the crisis, unless they were born too late, in which case they are not comparable.


I use the rapid, unforeseen increase of world food prices in early 2008 as a natural experiment to analyze the intergenerational effects of maternal nutrition on infant anemia. Using data from Senegal 2-4 years after the crisis, I am able to both quantify the effect of the 2008 crisis in Senegal and examine the effect of *in-utero* shocks on anemia in childhood. The causes of anemia and the consequences of the 2008 crisis have been explored separately by researchers. I am, to my knowledge, the first to connect the two.

We expect urban populations to be less vulnerable to drought and other natural disasters than the rural populace. There would then seem to be a trade-off where urban, well-connected populations are more vulnerable to the market, while rural, remote populations are vulnerable to nature. Here we must bring in that universal feature of social analysis: class. In either case, it is the poor who are vulnerable and the rich who are not. Any policy which considers mitigating the effect of these shocks, whether they come from the market or from nature, must keep poverty in the foreground. 

## Narrow Window

In the main specification, we are comparing infants exposed to the 2008 crisis *in-utero* to two control groups: 

1. Those who are exposed in childhood; and,
2. Those who are conceived after the crisis.

For reasons discussed above, including breastfeeding and delayed transmission of shocks, we would expect both of these groups to also experience a negative effect of the crisis. Thus, the ideal control group is to narrow the regression to the window just around those who had just been born and those who were still *in-utero*. I did not do this as my main specification because it would involve throwing out much of the data set, and would reduce my power. Next I report a more narrow specification, where I have thrown out over half the data-set. The data are restricted to those who were born between April 2007 and July 2009. The while the standard errors increase, the point estimates increase in magnitude, as expected if the effect is concentrated in these groups.


```{r narrow result,results = "asis",messages = FALSE}
load("~/Research/Anemia/Anemia/data/narrow_regression_table.Rdata")
texreg::texreg(list(u10,r10,u12,r12), 
                     digits = 4,
                     custom.model.names = c("2010: Urban","2010: Rural","2012: Urban","2012: Rural"),
                    omit.coef = "poly",
                     custom.coef.names =c("Intercept","Exposure") ,
                     override.pvalues = list(er1[,2],er2[,2],er3[,2],er4[,2]),
                     override.se = list(er1[,1],er2[,1],er3[,1],er4[,1]),
                     caption = "Restricted Sample Results",
                     float.pos = "H")

```

```{r narrow2 result,results = "asis",messages = FALSE}
load("~/Research/Anemia/Anemia/data/narrow_regression_table.Rdata")
 texreg::texreg(list(urb10,rur10,urb12,rur12), 
                         digits = 4,
                         custom.model.names = c("2010: Urban","2010: Rural","2012: Urban","2012: Rural"),
                         omit.coef = "poly",
                         custom.coef.names =c("Intercept","Exposure",
                                              "Distance to Dakar","Wealth",
                                              "Distance to Dakar * Exposure", "Wealth * Exposure") ,
                         override.pvalues = list(er5[,2],er6[,2],er7[,2],er8[2]),
                         override.se = list(er5[,1],er6[,1], er7[,1],er8[,1]),
                         caption =  "Restricted Sample Results",
                      float.pos = "H")


```

I take this as convincing evidence of the effect of the 2008 crisis. However, it was not the specification to which I pre-committed, so I have included it in the appendix as supporting evidence, rather than as my main specification.

```{r effect narrow distribution, fig.height = 6, fig.width = 10, fig.align = "center", caption = "Distribution of Effects"}
load("~/Research/Anemia/Anemia/data/narrow_effect_data.Rdata")
ggplot(eff)+geom_density(aes(x=effect,color=survey:urban))+scale_color_brewer(palette="Set1",labels = c("2010 Rural","2010 Urban","2012 Rural","2012 Urban"))+
labs(title ="PDF of Predicted Effects in terms of Hemoglobin-for-Age", x = "Effect", y = "Density")

ggplot(eff)+stat_ecdf(aes(x=effect,color=survey:urban))+scale_color_brewer(palette="Set1",labels = c("2010 Rural","2010 Urban","2012 Rural","2012 Urban"))+
labs(title ="CDF of Predicted Effects in terms of Hemoglobin-for-Age", x = "Effect", y = "Cumulative Probability")

```

Under the narrow specification, the median effect of the crisis on urban-dwellers in 2010 is greater than -.5 standard deviations. Thus, the typical urban dweller of Senegal suffered a -8 g/L shock to hemoglobin. 

```{r guide}
load("~/Research/Anemia/Anemia/data/effect_map.Rdata")
CapStr <- function(y) {
  c <- strsplit(y, " ")[[1]]
  paste(toupper(substring(c, 1,1)), substring(c, 2),
      sep="", collapse=" ")
}
map$region <- sapply(map$region, CapStr)
ggplot(data = map) + coord_equal()+
  geom_polygon( aes(x = long, y = lat, group=group, fill =region)) +
  geom_path(aes(x= long, y=lat,group=group), color = "white", size = .1)+
  labs(title = "Region Names: Senegal", x= "Longitude",y = "Latitude", fill = "Region")
```

```{r region table}
load("~/Research/Anemia/Anemia/data/hemforage.Rdata")
dhs$region <- sapply(dhs$region, CapStr)

knitr::kable(dhs %>% group_by(region) %>% summarise(Wealth = mean(wealth),Land = mean(land,na.rm=T),Urban = mean(as.numeric(urban)-1),N = n()), digits = 2, label = "Mean variables by Region")
```

## Hemoglobin-by-Age
```{r hemfa,fig.height = 6, fig.width = 10, fig.align = "center", fig.cap = "Hemoglobin Z-Score Transformation" }
load("~/Research/Anemia/Anemia/data/hem_by_age.Rdata")
hem_by_age$age <- as.numeric(hem_by_age$age)
ggplot(hem_by_age, aes(x=age, y=mean_hemo)) + 
    geom_ribbon(aes(ymin=mean_hemo-sd_hemo, ymax=mean_hemo+sd_hemo), width=.1,linetype=2, alpha=0.1) +
    geom_line() +
    geom_point()+ geom_hline(yintercept = 105)+
    labs(title = "Hemoglobin by Age: Mean and Standard Deviation", x = "Age in Months", y = "Hemoglobin: g/L")
```


An anemic infant is then more likely to develop into an anemic adult. Thus, an anemic mother begets anemic infant who becomes an anemic woman who begets an anemic child. This inter-generational aspect of anemia is well appreciated by the WHO and is recognized as an important issue at the nexus of public health, nutrition and female empowerment [@camaschellaIrondeficiencyAnemia2015].
Similarly, distance-to-Dakar should be considered as a general proxy for integration to the world market. Distance captures a broad set of socio-economic conditions. Areas further from Dakar are poorer, less-well educated and have more subsistence agriculture relative to commercial agriculture. Thus, the estimated effect will not be of transportation costs alone, but rather the combination general set of characteristics associated with being further from Dakar